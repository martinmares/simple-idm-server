❯ cargo test --test m2m_tests
   Compiling ring v0.17.14
   Compiling rustls v0.23.36
   Compiling rustls-webpki v0.103.8
   Compiling sqlx-core v0.8.6
   Compiling tokio-rustls v0.26.4
   Compiling rustls-platform-verifier v0.6.2
   Compiling hyper-rustls v0.27.7
   Compiling reqwest v0.13.1
   Compiling sqlx-postgres v0.8.6
   Compiling sqlx-macros-core v0.8.6
   Compiling sqlx-macros v0.8.6
   Compiling sqlx v0.8.6
   Compiling simple-idm-server v0.1.0 (/Users/mares/Development/Src/Rust/simple-idm-server)
warning: unused import: `Claims`
 --> src/auth/mod.rs:6:15
  |
6 | pub use jwt::{Claims, JwtService};
  |               ^^^^^^
  |
  = note: `#[warn(unused_imports)]` (part of `#[warn(unused)]`) on by default

warning: unused import: `hash_password`
 --> src/auth/mod.rs:7:20
  |
7 | pub use password::{hash_password, verify_password};
  |                    ^^^^^^^^^^^^^

warning: unused import: `JwtService`
 --> src/oauth2/authorization_code.rs:1:96
  |
1 | use crate::auth::{build_custom_claims, get_user_group_names, get_user_groups, verify_password, JwtService};
  |                                                                                                ^^^^^^^^^^

warning: unused import: `DbPool`
 --> src/oauth2/authorization_code.rs:2:79
  |
2 | use crate::db::{models::{AuthorizationCode, OAuthClient, RefreshToken, User}, DbPool};
  |                                                                               ^^^^^^

warning: unused import: `uuid::Uuid`
 --> src/oauth2/authorization_code.rs:9:5
  |
9 | use uuid::Uuid;
  |     ^^^^^^^^^^

warning: unused import: `TokenResponse`
  --> src/oauth2/authorization_code.rs:11:61
   |
11 | use super::client_credentials::{ErrorResponse, OAuth2State, TokenResponse};
   |                                                             ^^^^^^^^^^^^^

warning: variants `DecodeError` and `InvalidToken` are never constructed
  --> src/auth/jwt.rs:13:5
   |
 9 | pub enum JwtError {
   |          -------- variants in this enum
...
13 |     DecodeError(String),
   |     ^^^^^^^^^^^
...
17 |     InvalidToken,
   |     ^^^^^^^^^^^^
   |
   = note: `JwtError` has a derived impl for the trait `Debug`, but this is intentionally ignored during dead code analysis
   = note: `#[warn(dead_code)]` (part of `#[warn(unused)]`) on by default

warning: field `decoding_key` is never read
  --> src/auth/jwt.rs:35:5
   |
33 | pub struct JwtService {
   |            ---------- field in this struct
34 |     encoding_key: EncodingKey,
35 |     decoding_key: DecodingKey,
   |     ^^^^^^^^^^^^

warning: method `verify_token` is never used
  --> src/auth/jwt.rs:90:12
   |
39 | impl JwtService {
   | --------------- method in this implementation
...
90 |     pub fn verify_token(&self, token: &str) -> Result<Claims, JwtError> {
   |            ^^^^^^^^^^^^

warning: variants `HashError` and `InvalidPassword` are never constructed
  --> src/auth/password.rs:9:5
   |
 7 | pub enum PasswordError {
   |          ------------- variants in this enum
 8 |     #[error("Failed to hash password: {0}")]
 9 |     HashError(String),
   |     ^^^^^^^^^
...
13 |     InvalidPassword,
   |     ^^^^^^^^^^^^^^^
   |
   = note: `PasswordError` has a derived impl for the trait `Debug`, but this is intentionally ignored during dead code analysis

warning: function `hash_password` is never used
  --> src/auth/password.rs:16:8
   |
16 | pub fn hash_password(password: &str) -> Result<String, PasswordError> {
   |        ^^^^^^^^^^^^^

warning: field `refresh_token_expiry_seconds` is never read
  --> src/config.rs:26:9
   |
23 | pub struct JwtConfig {
   |            --------- field in this struct
...
26 |     pub refresh_token_expiry_seconds: i64,
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   |
   = note: `JwtConfig` has derived impls for the traits `Clone` and `Debug`, but these are intentionally ignored during dead code analysis

warning: struct `Group` is never constructed
  --> src/db/models.rs:19:12
   |
19 | pub struct Group {
   |            ^^^^^

warning: struct `UserGroup` is never constructed
  --> src/db/models.rs:27:12
   |
27 | pub struct UserGroup {
   |            ^^^^^^^^^

warning: fields `code`, `redirect_uri`, and `created_at` are never read
  --> src/db/models.rs:56:9
   |
55 | pub struct AuthorizationCode {
   |            ----------------- fields in this struct
56 |     pub code: String,
   |         ^^^^
...
59 |     pub redirect_uri: String,
   |         ^^^^^^^^^^^^
...
64 |     pub created_at: DateTime<Utc>,
   |         ^^^^^^^^^^
   |
   = note: `AuthorizationCode` has derived impls for the traits `Clone` and `Debug`, but these are intentionally ignored during dead code analysis

warning: fields `token` and `created_at` are never read
  --> src/db/models.rs:69:9
   |
68 | pub struct RefreshToken {
   |            ------------ fields in this struct
69 |     pub token: String,
   |         ^^^^^
...
74 |     pub created_at: DateTime<Utc>,
   |         ^^^^^^^^^^
   |
   = note: `RefreshToken` has derived impls for the traits `Clone` and `Debug`, but these are intentionally ignored during dead code analysis

warning: fields `device_code`, `user_code`, and `created_at` are never read
  --> src/db/models.rs:79:9
   |
78 | pub struct DeviceCode {
   |            ---------- fields in this struct
79 |     pub device_code: String,
   |         ^^^^^^^^^^^
80 |     pub user_code: String,
   |         ^^^^^^^^^
...
86 |     pub created_at: DateTime<Utc>,
   |         ^^^^^^^^^^
   |
   = note: `DeviceCode` has derived impls for the traits `Clone` and `Debug`, but these are intentionally ignored during dead code analysis

warning: `simple-idm-server` (bin "simple-idm-server") generated 17 warnings (run `cargo fix --bin "simple-idm-server" -p simple-idm-server` to apply 6 suggestions)
    Finished `test` profile [unoptimized + debuginfo] target(s) in 10.45s
     Running tests/m2m_tests.rs (target/debug/deps/m2m_tests-f6f26a95ab58f5d6)

running 1 test
TRUNCATE TABLE
INSERT 0 3
INSERT 0 5
INSERT 0 5
INSERT 0 2
INSERT 0 1
INSERT 0 3
INSERT 0 2
INSERT 0 1
               status
-------------------------------------
 Test data initialized successfully!
(1 row)

  info
--------
 Users:
(1 row)

 username |       email
----------+-------------------
 admin    | admin@example.com
 user1    | user1@example.com
 user2    | user2@example.com
(3 rows)

  info
---------
 Groups:
(1 row)

   name    |           description
-----------+---------------------------------
 admin     | Administrators with full access
 users     | Regular users
 reports   | Users who can view reports
 billing   | Users who can access billing
 analytics | Users who can access analytics
(5 rows)

      info
----------------
 OAuth Clients:
(1 row)

    client_id     |         name         |                  grant_types
------------------+----------------------+------------------------------------------------
 api_service      | API Service M2M      | {client_credentials}
 webapp_dashboard | Dashboard Web App    | {authorization_code,refresh_token}
 smart_tv_app     | Smart TV Application | {urn:ietf:params:oauth:grant-type:device_code}
(3 rows)

     info
--------------
 User Groups:
(1 row)

 username | group_name
----------+------------
 admin    | admin
 admin    | analytics
 admin    | billing
 admin    | reports
 admin    | users
 user1    | reports
 user1    | users
 user2    | users
(8 rows)

    info
-------------
 Claim Maps:
(1 row)

     client_name      | group_name |    claim_name
----------------------+------------+------------------
 Dashboard Web App    | admin      | is_admin
 Dashboard Web App    | reports    | can_view_reports
 Smart TV Application | users      | is_user
(3 rows)

warning: unused import: `Claims`
 --> src/auth/mod.rs:6:15
  |
6 | pub use jwt::{Claims, JwtService};
  |               ^^^^^^
  |
  = note: `#[warn(unused_imports)]` (part of `#[warn(unused)]`) on by default

warning: unused import: `hash_password`
 --> src/auth/mod.rs:7:20
  |
7 | pub use password::{hash_password, verify_password};
  |                    ^^^^^^^^^^^^^

warning: unused import: `JwtService`
 --> src/oauth2/authorization_code.rs:1:96
  |
1 | use crate::auth::{build_custom_claims, get_user_group_names, get_user_groups, verify_password, JwtService};
  |                                                                                                ^^^^^^^^^^

warning: unused import: `DbPool`
 --> src/oauth2/authorization_code.rs:2:79
  |
2 | use crate::db::{models::{AuthorizationCode, OAuthClient, RefreshToken, User}, DbPool};
  |                                                                               ^^^^^^

warning: unused import: `uuid::Uuid`
 --> src/oauth2/authorization_code.rs:9:5
  |
9 | use uuid::Uuid;
  |     ^^^^^^^^^^

warning: unused import: `TokenResponse`
  --> src/oauth2/authorization_code.rs:11:61
   |
11 | use super::client_credentials::{ErrorResponse, OAuth2State, TokenResponse};
   |                                                             ^^^^^^^^^^^^^

warning: variants `DecodeError` and `InvalidToken` are never constructed
  --> src/auth/jwt.rs:13:5
   |
 9 | pub enum JwtError {
   |          -------- variants in this enum
...
13 |     DecodeError(String),
   |     ^^^^^^^^^^^
...
17 |     InvalidToken,
   |     ^^^^^^^^^^^^
   |
   = note: `JwtError` has a derived impl for the trait `Debug`, but this is intentionally ignored during dead code analysis
   = note: `#[warn(dead_code)]` (part of `#[warn(unused)]`) on by default

warning: field `decoding_key` is never read
  --> src/auth/jwt.rs:35:5
   |
33 | pub struct JwtService {
   |            ---------- field in this struct
34 |     encoding_key: EncodingKey,
35 |     decoding_key: DecodingKey,
   |     ^^^^^^^^^^^^

warning: method `verify_token` is never used
  --> src/auth/jwt.rs:90:12
   |
39 | impl JwtService {
   | --------------- method in this implementation
...
90 |     pub fn verify_token(&self, token: &str) -> Result<Claims, JwtError> {
   |            ^^^^^^^^^^^^

warning: variants `HashError` and `InvalidPassword` are never constructed
  --> src/auth/password.rs:9:5
   |
 7 | pub enum PasswordError {
   |          ------------- variants in this enum
 8 |     #[error("Failed to hash password: {0}")]
 9 |     HashError(String),
   |     ^^^^^^^^^
...
13 |     InvalidPassword,
   |     ^^^^^^^^^^^^^^^
   |
   = note: `PasswordError` has a derived impl for the trait `Debug`, but this is intentionally ignored during dead code analysis

warning: function `hash_password` is never used
  --> src/auth/password.rs:16:8
   |
16 | pub fn hash_password(password: &str) -> Result<String, PasswordError> {
   |        ^^^^^^^^^^^^^

warning: field `refresh_token_expiry_seconds` is never read
  --> src/config.rs:26:9
   |
23 | pub struct JwtConfig {
   |            --------- field in this struct
...
26 |     pub refresh_token_expiry_seconds: i64,
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   |
   = note: `JwtConfig` has derived impls for the traits `Clone` and `Debug`, but these are intentionally ignored during dead code analysis

warning: struct `Group` is never constructed
  --> src/db/models.rs:19:12
   |
19 | pub struct Group {
   |            ^^^^^

warning: struct `UserGroup` is never constructed
  --> src/db/models.rs:27:12
   |
27 | pub struct UserGroup {
   |            ^^^^^^^^^

warning: fields `code`, `redirect_uri`, and `created_at` are never read
  --> src/db/models.rs:56:9
   |
55 | pub struct AuthorizationCode {
   |            ----------------- fields in this struct
56 |     pub code: String,
   |         ^^^^
...
59 |     pub redirect_uri: String,
   |         ^^^^^^^^^^^^
...
64 |     pub created_at: DateTime<Utc>,
   |         ^^^^^^^^^^
   |
   = note: `AuthorizationCode` has derived impls for the traits `Clone` and `Debug`, but these are intentionally ignored during dead code analysis

warning: fields `token` and `created_at` are never read
  --> src/db/models.rs:69:9
   |
68 | pub struct RefreshToken {
   |            ------------ fields in this struct
69 |     pub token: String,
   |         ^^^^^
...
74 |     pub created_at: DateTime<Utc>,
   |         ^^^^^^^^^^
   |
   = note: `RefreshToken` has derived impls for the traits `Clone` and `Debug`, but these are intentionally ignored during dead code analysis

warning: fields `device_code`, `user_code`, and `created_at` are never read
  --> src/db/models.rs:79:9
   |
78 | pub struct DeviceCode {
   |            ---------- fields in this struct
79 |     pub device_code: String,
   |         ^^^^^^^^^^^
80 |     pub user_code: String,
   |         ^^^^^^^^^
...
86 |     pub created_at: DateTime<Utc>,
   |         ^^^^^^^^^^
   |
   = note: `DeviceCode` has derived impls for the traits `Clone` and `Debug`, but these are intentionally ignored during dead code analysis

warning: `simple-idm-server` (bin "simple-idm-server") generated 17 warnings (run `cargo fix --bin "simple-idm-server" -p simple-idm-server` to apply 6 suggestions)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.50s
     Running `target/debug/simple-idm-server`
2026-01-14T19:33:28.248623Z  INFO simple_idm_server: Starting simple-idm-server
2026-01-14T19:33:28.248701Z  INFO simple_idm_server: Server: 127.0.0.1:8080
2026-01-14T19:33:28.248706Z  INFO simple_idm_server: Database: postgres://postgres:postgres@localhost:5432/simple_idm
2026-01-14T19:33:28.319873Z  INFO simple_idm_server: Connected to database
2026-01-14T19:33:28.348243Z  INFO simple_idm_server: Migrations completed
Error: Os { code: 48, kind: AddrInUse, message: "Address already in use" }
test test_m2m_full_integration ... FAILED

failures:

---- test_m2m_full_integration stdout ----
Starting Docker services...
Docker services started
Waiting for PostgreSQL to be ready...
PostgreSQL is ready!
Running database setup and seed data...
Database setup completed
Building application...
Application built successfully
Starting application server...
Server process started, waiting for health check...
Waiting for server to be ready...
Server is ready!

=== Running M2M OAuth2 Client Credentials Tests ===

Test 1: Successfully obtain access token with correct credentials
✅ Test 1 PASSED: Successfully obtained access token

Test 2: Failure with incorrect client_secret

thread 'test_m2m_full_integration' (101344185) panicked at tests/m2m_tests.rs:382:5:
assertion `left == right` failed: Expected 401 Unauthorized, got 200 OK
  left: 200
 right: 401
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace


failures:
    test_m2m_full_integration

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 16.77s

error: test failed, to rerun pass `--test m2m_tests`

